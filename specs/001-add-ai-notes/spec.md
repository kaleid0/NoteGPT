# 功能规范: Web 端 AI 笔记应用

**功能分支**: `001-add-ai-notes`
**创建时间**: 2026-01-12
**状态**: 草稿
**输入**: 用户描述: "项目名称: web 端 AI笔记应用; 构建微型 AI 驱动笔记应用，支持记录与润色想法；目标双端可用、实时流畅、用户友好；功能要求：笔记列表/详情、CRUD、浏览器端持久化（加分: 后端存储）；AI 助手：AI 处理按钮、选中文本或全文处理、弹出流式响应悬浮框、接受/丢弃交互；API Key 配置友好和安全。"

## 用户场景与测试 *(必填)*

### 用户故事 1 - 管理笔记 (优先级: P1)

用户可以在笔记列表页看到创建的笔记，并能点击进入笔记详情页查看或编辑。用户可以创建新笔记、保存编辑、以及删除笔记。

**优先级原因**: 核心产品价值 - 允许用户记录想法是基础。

**独立测试**:
- 在空白状态下创建一个笔记，输入内容并保存，刷新页面后该笔记出现在列表中并能打开查看。
- 编辑笔记内容并保存，刷新后修改仍存在。
- 删除笔记后，笔记从列表中移除并持久化删除状态。

**验收场景**:
1. **给定** 用户在笔记列表页，**当** 用户点击“新建笔记”并输入 "测试内容" 并保存，**那么** 列表显示该笔记且能打开详情并看到 "测试内容"。
2. **给定** 用户在笔记详情页，**当** 用户修改内容并保存，**那么** 刷新页面后仍显示已修改内容。
3. **给定** 用户在笔记详情页，**当** 用户点击删除并确认，**那么** 笔记从列表中移除并在浏览器持久存储中删除。

---

### 用户故事 2 - AI 助手交互 (优先级: P1) 🎯

在笔记详情页，用户通过“AI 处理”按钮触发 AI。若用户高亮选中文本，则仅处理被选中的文本；若未选中文本，则处理整篇笔记。触发后会弹出一个悬浮框（Modal/Popover），AI 响应以流式 (streaming) 方式逐字显示在悬浮框中。悬浮框提供“接受”和“丢弃”选项：接受替换原文（或选中文本），丢弃关闭悬浮框且不修改原文。

**优先级原因**: 这是产品差异化特性，带来直接用户价值（快速润色、总结想法）。

**独立测试**:
- 在笔记详情页选中一段文本并触发 AI，悬浮框以流式方式显示生成的文本，点击“接受”后，该选区被替换为生成内容；点击“丢弃”后，原文无变化。
- 在未选中文本的情况下触发 AI，悬浮框生成内容并能选择接受/丢弃；接受时整篇笔记被替换。
- 在生成过程中，原笔记内容不会被修改，且用户可以取消操作（关闭悬浮框）以丢弃生成内容。

**验收场景**:
1. **给定** 用户在详情页选中了文本，**当** 用户点击“AI 处理”并等待生成，**那么** 悬浮框显示流式内容, 并且“接受”会替换选中文本。
2. **给定** 用户在详情页未选中文本，**当** 用户点击“AI 处理”，**那么** 悬浮框显示对整篇笔记的处理结果，**当** 用户点击“接受”，**那么** 整篇笔记被替换。
3. **给定** 生成出现错误或网络问题，**当** 用户触发 AI，**那么** 悬浮框显示友好错误信息并提供重试或丢弃选项。

---

### 用户故事 3 - API 配置与安全 (优先级: P2)

项目应对 LLM API 的配置做到“开箱即用或易于配置”。API Key 需以安全的方式管理（例如后端代理/环境变量），并提供明确的说明便于面试官配置和测试。

**优先级原因**: 安全与可试用性直接影响项目的演示质量和可交付性。

**独立测试**:
- 提供示例配置说明，验证在本地运行时能配置 API Key 并成功触发 LLM（或使用提供的演示/沙盒模型）。

---

### 边界情况

- 当笔记为空时触发 AI，应提示用户并拒绝空输入。
- 当选中文本仅包含空格或换行时，按全稿处理或提示用户选择有效文本。
- 当模型流式中断或网络错误时，应在悬浮框显示错误与重试按钮，且原笔记不被修改。
- 对超长笔记（超过模型推荐长度）应展示截断警告或告知用户可能需要分段处理。

## 需求 *(必填)*

### 功能需求

- **FR-001**: 系统必须在笔记列表页列出所有笔记，支持打开笔记详情。
- **FR-002**: 系统必须允许创建新笔记、编辑和删除笔记。
- **FR-003**: 笔记内容必须在浏览器端持久化以保证刷新后数据不丢失（默认实现：浏览器端持久化; 可选：后端存储）。
- **FR-004**: 在笔记详情页必须显示“AI 处理”按钮，用于触发 AI 交互。
- **FR-005**: 当用户选中文本后触发 AI，应仅处理被选中的文本。
- **FR-006**: 当用户未选中文本后触发 AI，应处理整篇笔记的全部内容。
- **FR-007**: 触发 AI 后应弹出悬浮框(Modal/Popover)，并以流式 (streaming) 方式逐字显示响应。
- **FR-008**: 在流式生成期间，原笔记内容不得被改动，直到用户明确“接受”。
- **FR-009**: 悬浮框必须提供“接受”和“丢弃”操作：接受替换对应文本，丢弃关闭并不修改原文。
- **FR-010**: 系统必须提供清晰的错误与重试路径（当模型失败或请求超时）。
- **FR-011**: 系统必须提供 API Key 配置说明并建议安全的存储方法（例如通过后端代理或环境变量）。
- **FR-012**: 系统应允许使用至少一种提供免费额度并支持流式输出的 LLM API（示例: OpenAI 或其他具有免费额度的提供商），并允许更换不同提供商的配置。

### 关键实体

- **Note**: 代表单个笔记，关键属性: id (string), title (string, optional), content (string), created_at (ISO datetime), updated_at (ISO datetime), tags (optional list)

## 成功标准 *(必填)*

### 可衡量的结果

- **SC-001**: 用户能够在 2 分钟内完成从创建笔记到保存并通过刷新验证持久化的流程（手动/自动验收）。
- **SC-002**: AI 首字符延迟：在正常网络条件下，首字符延迟 **p95 ≤ 2s**（通过自动化性能测试/Playwright perf 测量并在 CI 中记录为性能基线）。
- **SC-003**: 在触发 AI 的常见错误场景下（网络失败、模型返回错误），系统在悬浮框中显示明确的错误信息并提供重试或丢弃选项。
- **SC-004**: API 配置与示例说明使面试官能在 5 分钟内完成本地配置并成功触发 LLM（或使用项目提供的演示模型）。
- **SC-005**: 核心模块单元测试覆盖率（核心逻辑/hooks/services）**>= 80%**（在 CI 中可测量并报告）。

## 假设

- 默认采用浏览器端持久存储(IndexedDB) 以满足“刷新不丢失数据”的要求；可选集成后端服务用于集中存储与跨设备同步（加分项）。
- 假定选择的 LLM 提供流式响应能力或项目会使用后端代理来实现流式传递。

## 技术约束与非功能需求

- 项目应定义必要的非功能约束（可测试性、可用性、可观测性），但应**避免在规范中强制具体实现技术**；实现选项与推荐技术应记录在 `plan.md` 中作为实现参考。
- 可测试性：端到端、集成与单元测试必须覆盖关键用户路径，并在 CI 中具备基本回归检测。
- 可观测性：关键交互（例如 AI 首字符延迟、错误率）必须可度量并在 CI 中设置性能基线/回归检测占位。
- 用户体验稳定性：实施错误边界（Error Boundary）、请求超时和友好降级，避免白屏或完整崩溃；关键路径应具备回退策略。
- 响应式与无障碍：采用移动优先原则并在多个视口与 a11y 工具下进行验证。
- 可部署性：提供本地运行与演示部署说明（包括演示/沙盒模式），以便在无外部 API Key 时进行离线演示。

> 实现选项（示例）请查看 `specs/001-add-ai-notes/plan.md` 中的 "实现选项" 部分。

## 已解决的澄清项

- **Q1 (API Key 管理与安全)**: 选择 **A: 包含后端代理**。实现将包含一个小型后端代理服务，用于安全存储 API Key 与转发 LLM 请求。文档将包含部署、运行与配置说明，并在 README 中强调安全注意事项与演示步骤。

- **Q2 (LLM 提供商)**: 选择 **A: 推荐 OpenAI 作为默认示例**，但实现应保持供应商可替换性。默认示例与演示使用 OpenAI（或兼容 OpenAI API 的提供商）以展示流式接口；文档应说明如何替换为其他供应商。

- **Q3 (浏览器端持久化)**: 选择 **A: IndexedDB (推荐)**。将默认使用 IndexedDB（通过轻量抽象层）以支持大文本和异步读写；为简单场景保留 localStorage 的后备适配选项（可配）。

---

## 交付物清单（已更新）

- UI: 笔记列表页、笔记详情页、笔记编辑功能、AI 处理按钮、流式悬浮框
- 持久化: 默认 IndexedDB 实现 (异步、适合大文本); 提供 localStorage 作为后备
- 后端: 提供一个可运行的后端代理（本地开发与部署指南）用于安全转发 LLM 请求
- LLM: 应支持流式响应；示例实现使用 OpenAI 流式 API，并提供说明以替换为其他供应商
- 文档: 快速启动、API Key 配置、安全考量、演示指南、测试说明

---

**备注**: 我将替换 `spec.md` 中的 [NEEDS CLARIFICATION] 段，并更新相关 checklists 与 tasks，以反映这些决策。